import { Component, ViewChild } from '@angular/core';
import chartJs from 'chart.js';
import { Router } from '@angular/router';
import { AnalisadorService } from '../services/analisador.service';
import { ngxCsv } from 'ngx-csv/ngx-csv';
import { File } from '@ionic-native/file/ngx';


@Component({
  selector: 'app-tab3',
  templateUrl: 'tab3.page.html',
  styleUrls: ['tab3.page.scss']
})
export class Tab3Page {

  @ViewChild('barCanvas') barCanvas;

  @ViewChild('barCanvas2') barCanvas1;

  @ViewChild('barCanvas3') barCanvas2;

  mensagem: string = '';
  resposta: any;
  listaR: number[];
  listaG: number[];
  listaB: number[];
  barChart: any;
  barChart1: any;
  barChart2: any;

  arquivo: any;
  caminho: any;

  x =  '[0, 1, 5, 8, 13, 23, 25, 32, 41, 47, 72, 97, 123, 159, 183, 220, 248, 268, 326, 423, 598, 903, 1386, 2027, 2672, 2889, 2836, 2441, 2166, 1990, 2090, 1955, 1579, 1402, 1542, 1719, 1939, 1639, 1325, 1108, 1034, 1150, 1384, 1570, 1942, 2244, 2863, 3772, 4939, 5934, 6113, 5534, 5340, 5126, 4684, 4081, 2315, 932, 326, 229, 231, 258, 284, 318, 325, 407, 386, 460, 553, 581, 628, 640, 655, 591, 552, 573, 579, 612, 717, 780, 792, 839, 835, 697, 652, 608, 538, 600, 547, 523, 529, 501, 522, 538, 506, 497, 491, 528, 491, 497, 524, 489, 526, 515, 507, 536, 561, 647, 662, 674, 690, 693, 731, 651, 686, 760, 828, 808, 697, 694, 617, 738, 792, 851, 837, 846, 938, 896, 896, 898, 654, 503, 463, 414, 428, 404, 426, 375, 385, 424, 451, 426, 442, 439, 379, 332, 380, 396, 325, 358, 390, 387, 408, 472, 435, 408, 410, 358, 398, 384, 383, 394, 401, 460, 490, 549, 595, 792, 872, 1061, 1228, 1489, 1805, 2132, 2239, 2367, 2462, 2632, 2569, 2064, 1903, 1803, 1559, 1040, 937, 941, 713, 593, 713, 682, 851, 991, 883, 1056, 1180, 1447, 1615, 1651, 1951, 2144, 2905, 3648, 3495, 2701, 1653, 1210, 1887, 2304, 2351, 634, 93, 62, 53, 58, 45, 75, 37, 11, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]'
  dados = '[62,14,13,22,29,25,42,50,74,110,159,228,246,355,486,696,1058,1349,1820,2502,3109,3530,3950,3290,2724,2845,2694,2283,1995,1759,1510,1297,1197,1127,1159,1011,1014,925,888,855,863,957,1071,1159,1071,1015,1028,1090,1055,1138,1229,1254,1299,1442,1477,1666,1681,1600,1631,1654,1551,1478,1454,1451,1478,1430,1429,1281,1192,1037,942,961,905,837,732,768,678,705,652,708,662,643,621,598,615,535,592,499,572,524,526,487,516,433,472,534,567,509,581,601,601,658,686,750,775,787,760,679,629,608,649,851,971,1002,1057,1054,906,698,659,664,693,643,689,656,822,728,712,683,617,703,814,805,732,864,1062,1057,1373,1399,1233,1365,1318,1343,1555,1814,1709,1430,1307,1567,1702,1666,1664,1789,2245,2499,2597,3057,3404,3436,4369,5832,6387,5524,5514,5741,5886,4813,3797,2072,531,226,203,188,165,177,150,121,71,37,20,19,10,13,12,13,8,8,11,7,9,8,6,4,3,8,5,9,5,10,10,7,4,8,5,12,8,10,7,8,4,7,8,9,10,21,5,10,9,5,7,8,7,10,6,5,8,5,9,9,6,6,8,13,12,9,12,11,3,14,11,13,18,22,20,14,20,23,21,36,47,33,44,114,150,265,1131,0]';
  dadosMock2 = '[0,0,0,0,19,10,74,128,576,1737,2474,2000,1293,923,707,629,650,743,592,358,210,212,230,295,278,273,308,361,498,564,517,461,407,397,359,286,243,294,286,261,209,172,169,177,185,205,179,172,199,157,114,102,77,66,79,90,75,80,82,90,83,88,84,96,97,126,132,151,173,205,269,327,402,610,709,808,947,985,929,763,875,927,959,1026,1214,1129,1016,951,995,980,1026,931,836,840,757,715,642,722,748,655,623,628,575,547,535,550,553,619,615,603,576,610,686,784,933,1030,1374,1816,2141,2541,2826,2888,3181,3769,4016,3976,4111,4362,4325,4250,3797,3461,3313,2793,2575,2387,2255,2028,1559,1396,1196,1000,888,764,616,498,453,374,331,298,329,276,310,306,327,323,382,387,453,497,522,561,575,650,687,868,957,1332,1615,2026,2398,2508,2624,2357,2282,2237,2171,2256,2175,2202,2316,2444,2508,2625,2692,2653,2409,2242,2335,2344,2475,2435,2411,2128,2031,1926,1972,1743,1730,1528,1283,1152,1081,920,907,849,775,855,773,629,525,401,362,327,276,259,247,162,143,93,94,72,55,40,38,25,30,21,23,27,15,18,17,12,19,15,13,7,6,3,5,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0]';
  dadosMock3 = '[68,45,31,114,422,1175,1900,2332,1974,1157,632,558,779,857,639,388,262,260,246,247,225,225,265,337,474,512,502,529,480,506,450,376,341,290,244,194,216,170,161,210,192,144,119,76,59,74,63,60,78,70,73,78,99,83,82,107,115,112,130,147,126,153,141,179,191,206,260,371,432,519,668,719,731,799,882,981,1073,1178,1208,1217,1113,1026,1008,1164,1265,1383,1318,1182,1094,905,907,831,735,717,715,709,689,622,683,671,634,695,813,821,955,1341,1767,2225,2736,3213,3542,4073,4304,4218,4333,4298,4116,4079,3828,3482,3266,2984,2617,2413,2182,1991,1848,1543,1303,1185,1065,804,692,566,454,347,309,313,266,221,208,226,195,197,214,222,220,248,250,244,280,295,385,417,590,725,1034,1267,1539,1836,1894,1819,1399,1174,1090,1091,1107,1074,1059,1213,1429,1670,1887,2036,1861,1783,1569,1662,1739,1723,1601,1642,1606,1584,1626,1718,1792,1705,1742,1705,1706,1721,1572,1559,1628,1546,1456,1477,1494,1406,1271,1233,1261,1241,1209,1200,1257,1105,1036,1039,1047,960,915,834,797,831,687,625,624,562,478,401,324,242,159,115,73,57,50,35,36,35,25,23,13,18,9,13,13,9,8,4,1,1,0,0,0,0,0,0,0,0,0,0,0,0]';
  array = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32',
       '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66',
        '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99', '100',
         '101', '102', '103', '104', '105', '106', '107', '108', '109', '110', '111', '112', '113', '114', '115', '116', '117', '118', '119', '120', '121', '122', '123', '124', '125', '126', '127',
          '128', '129', '130', '131', '132', '133', '134', '135', '136', '137', '138', '139', '140', '141', '142', '143', '144', '145', '146', '147', '148', '149', '150', '151', '152', '153', '154',
           '155', '156', '157', '158', '159', '160', '161', '162', '163', '164', '165', '166', '167', '168', '169', '170', '171', '172', '173', '174', '175', '176', '177', '178', '179', '180', '181',
            '182', '183', '184', '185', '186', '187', '188', '189', '190', '191', '192', '193', '194', '195', '196', '197', '198', '199', '200', '201', '202', '203', '204', '205', '206', '207', '208',
             '209', '210', '211', '212', '213', '214', '215', '216', '217', '218', '219', '220', '221', '222', '223', '224', '225', '226', '227', '228', '229', '230', '231', '232', '233', '234', '235',
              '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '250', '251', '252', '253', '254', '255'];
  //dadosf =  this.tratar(this.dadosMock)
  dadosg =  this.tratar(this.dadosMock2)
  dadosh =  this.tratar(this.dadosMock3)
  teste: any[]=[];

  constructor(public router: Router,
              private analiserService: AnalisadorService,
              private file: File){

  }

  ngOnInit(){
    if(this.analiserService.getImagem()){     
      this.mensagem = this.analiserService.getImagem();
           
    }
  }

  ionViewWillEnter(){
    this.mensagem = this.analiserService.getImagem();
    this.geraHisto();
    this.teste.push(this.dadosg);
    this.teste.push(this.dadosh);
  }


  getChart(context, chartType, data, options?) {
    return new chartJs(context, {
      data,
      options,
      type: chartType
    })
  }

  getBarChart(contexto: any, dados: any, cor: any){
    const array = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32',
       '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66',
        '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99', '100',
         '101', '102', '103', '104', '105', '106', '107', '108', '109', '110', '111', '112', '113', '114', '115', '116', '117', '118', '119', '120', '121', '122', '123', '124', '125', '126', '127',
          '128', '129', '130', '131', '132', '133', '134', '135', '136', '137', '138', '139', '140', '141', '142', '143', '144', '145', '146', '147', '148', '149', '150', '151', '152', '153', '154',
           '155', '156', '157', '158', '159', '160', '161', '162', '163', '164', '165', '166', '167', '168', '169', '170', '171', '172', '173', '174', '175', '176', '177', '178', '179', '180', '181',
            '182', '183', '184', '185', '186', '187', '188', '189', '190', '191', '192', '193', '194', '195', '196', '197', '198', '199', '200', '201', '202', '203', '204', '205', '206', '207', '208',
             '209', '210', '211', '212', '213', '214', '215', '216', '217', '218', '219', '220', '221', '222', '223', '224', '225', '226', '227', '228', '229', '230', '231', '232', '233', '234', '235',
              '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '250', '251', '252', '253', '254', '255'];
    const data = {
      labels: array,
      datasets: [{
        label: 'intensidade de pixels',
        data: dados,
        backgroundColor: cor,         
        borderWidth: 1
      }]
    };

    const options = {
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true
          }
        }]
      }
    }

    return this.getChart(contexto.nativeElement, 'bar', data, options);
  }

  ngAfterViewInit(){
   if(this.mensagem !== this.analiserService.getImagem()){
      this.mensagem = this.analiserService.getImagem();
    } 
  }

  avancar(): void {
    this.router.navigate(['/tabs/tab1']).then(()=>{})
  }

  geraHisto(){
    this.analiserService.outra(this.mensagem).subscribe(lista => {
      this.listaR =  this.tratar(lista.histo[0]);
      this.listaG =  this.tratar(lista.histo[1]);
      this.listaB =  this.tratar(lista.histo[2]);
      this.resposta = lista;
      this.analiserService.resposta.push(this.listaR);
      this.analiserService.resposta.push(this.listaG);
      this.analiserService.resposta.push(this.listaB); 

      this.barChart = this.getBarChart(this.barCanvas, this.listaR, 'rgb(255, 0, 0)');
      this.barChart1 = this.getBarChart(this.barCanvas1, this.listaG, 'rgb(156, 230, 20)');
      this.barChart2 = this.getBarChart(this.barCanvas2, this.listaB, 'rgb(20, 0, 255)');
    }, error =>{
      this.resposta = error;
    });
  }

  tratar(res:string): number[] {
    let lista = res.split(',');
    let size = lista.length;
    lista[0] = lista[0].split('[')[1];
    lista[(size-1)] = lista[(size-1)].split(']')[0];
    return lista.map(item => parseInt(item, 10));
  }


  options: any = {
    fieldSeparator: ';',
    quoteStrings: '"',
    decimalseparator: '.',
    showLabels: false,
    showTitle: false,
    title: 'Histogramas',
    useBom: false,
    noDownload: false,
    headers: false
  };

  geraCsv() {
    this.arquivo = new ngxCsv(this.analiserService.resposta, 'ArquivoHistograma', this.options);
  }


  criarPasta(){
    return this.file.createDir(this.file.externalApplicationStorageDirectory, 'csv', true).then((res)=>{
      alert('A pasta foi criada: ' + res.toURL());
      this.caminho =  res.toURL()
    })
  }

  salvaArquivo(){
    const data = Date.now().toString();
    let nomeArquivo = `Histograma-${data}.csv`;
    this.file.writeFile(this.caminho, nomeArquivo, this.arquivo).then((res)=>{
      alert('Arquivo foi salvo!' + this.caminho);
      //console.log(res.json())
    }).catch(error => {
      alert('Não foi possível salvar!' + error);
      console.log(error);
    })
  }

  async salvarResultado(){
    this.geraCsv();
    await this.criarPasta();
    await this.salvaArquivo();

  }
}
